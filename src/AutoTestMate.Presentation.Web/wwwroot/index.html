<!doctype html> 
<html>
<head>
  <meta charset="utf-8"/>
  <title>AutoTestMate — Test Generation Live</title>
  <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --pill:#f8fafc; --pill-bd:#e2e8f0; --brand:#2563eb;
      --c-llm:#fb7185; --c-tool:#22c55e; --c-agent:#38bdf8; --c-oth:#9ca3af;
      --c-prompt:#f59e0b; /* amber/orange for prompt events */

    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui;margin:18px;color:var(--fg);background:var(--bg)}
    h1{margin:0 0 8px 0}
    .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;flex:1}
    .header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .pill{background:var(--pill);border:1px solid var(--pill-bd);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .btn.danger{background:#fff1f2;border-color:#fee2e2;color:#b91c1c}
    .btn.brand{background:#eff6ff;border-color:#dbeafe;color:#1d4ed8}
    input[type="text"]{padding:6px 8px;border:1px solid var(--line);border-radius:8px;min-width:220px}
    .legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .strip{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .node{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827}
    .node.active{outline:2px solid var(--brand);outline-offset:2px;background:#f0f9ff}
    .tiny{font-size:12px;color:var(--muted)}
    #tl-svg{width:100%;height:90px;display:block;border-radius:10px;border:1px solid var(--line)}
    .feed{max-height:280px;overflow:auto;border-top:1px solid var(--line);margin-top:8px}
    .rowfeed{display:grid;grid-template-columns:100px 140px 1fr;gap:8px;padding:8px 6px;border-bottom:1px solid #f8fafc;font-family:ui-monospace}
    .rowfeed b{font-family:ui-sans-serif}
    table{width:100%;border-collapse:collapse;font-family:ui-monospace}
    th,td{padding:8px 6px;border-bottom:1px solid #f8fafc;text-align:left;vertical-align:top}
    .minitimeline{width:180px;height:16px}
    .kbd{font-family:ui-monospace;background:#0f172a0d;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="header">
    <h1>AutoTestMate — Test Generation Live</h1>
    <div class="pill">Focused mode: Code Design & Generation</div>
  </div>

  <!-- LLM internals strip -->
  <div class="card">
    <div class="header">
      <strong>LLM Internals (compact)</strong>
      <div class="tiny">Highlights when an event arrives</div>
    </div>
    <div class="strip" id="internals">
      <div id="n-prompt" class="node">Prompt.Render</div>
      <div id="n-req" class="node">LLM.Request</div>
      <div id="n-stream" class="node">Stream.Text</div>
      <div id="n-call" class="node">Tool.Call</div>
      <div id="n-res" class="node">Tool.Result</div>
      <div id="n-lres" class="node">LLM.Response</div>
      <div id="n-final" class="node">LLM.Final</div>
    </div>
  </div>

  <!-- Registered tools -->
  <div class="card">
    <div class="header">
      <strong>Registered Tools</strong>
      <span class="tiny">Publish <span class="kbd">SK:Tools.Registered</span> with a CSV list</span>
    </div>
    <div id="tools" class="strip tiny" style="gap:6px;"></div>
  </div>

  <!-- Live timeline -->
  <div class="card">
    <div class="header">
      <strong>Live Timeline</strong>
      <div class="controls">
        <label><input type="checkbox" id="ck-agent" checked> Agent</label>
        <label><input type="checkbox" id="ck-prompt" checked> PromptRender</label>
        <label><input type="checkbox" id="ck-llm" checked> LLM</label>
        <label><input type="checkbox" id="ck-tool" checked> Tool Call</label>
        <label><input type="checkbox" id="ck-oth" checked> Other</label>
        <input type="text" id="q" placeholder="Search message/data…">
        <button class="btn" id="zoom-in">Zoom +</button>
        <button class="btn" id="zoom-out">Zoom –</button>
        <button class="btn" id="export">Export JSON</button>
        <button class="btn danger" id="clear">Clear</button>
      </div>
    </div>
    <svg id="tl-svg"></svg>
    <div class="legend" style="margin-top:8px">
      <span><span class="dot" style="background:var(--c-agent)"></span>Agent</span>
      <span><span class="dot" style="background:var(--c-prompt)"></span>PromptRender</span>
      <span><span class="dot" style="background:var(--c-llm)"></span>LLM</span>
      <span><span class="dot" style="background:var(--c-tool)"></span>Tool Call</span>
      <span><span class="dot" style="background:var(--c-oth)"></span>Other</span>
    </div>
    <div id="feed" class="feed"></div>
  </div>

  <!-- Tool calls table -->
  <div class="card">
    <div class="header">
      <strong>Tool Calls</strong>
      <div class="controls">
        <span class="pill" id="tc-count">0</span>
        <input type="text" id="tc-search" placeholder="Search in args/results…">
        <select id="tc-plugin"><option value="">All plugins</option></select>
        <select id="tc-func"><option value="">All functions</option></select>
        <label><input type="checkbox" id="ph-call" checked> Call</label>
        <label><input type="checkbox" id="ph-args" checked> Args</label>
        <label><input type="checkbox" id="ph-res" checked> Result</label>
        <button class="btn" id="tc-export">Export JSON</button>
        <button class="btn danger" id="tc-clear">Clear</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Time</th><th>Plugin</th><th>Function</th><th>Timeline</th><th>Details</th><th>Copy</th>
        </tr>
      </thead>
      <tbody id="tc-body"></tbody>
    </table>
  </div>

<script>
  const conn = new signalR.HubConnectionBuilder().withUrl('/flow').withAutomaticReconnect().build();
  conn.start().catch(console.error);

  const el = id => document.getElementById(id);
  const nowMs = e => e.at ? Date.parse(e.at) : Date.now();
  const pulse = (e) => { e.classList.remove('active'); void e.offsetWidth; e.classList.add('active'); setTimeout(()=>e.classList.remove('active'), 600); };

  const N = { prompt:el('n-prompt'), req:el('n-req'), stream:el('n-stream'), call:el('n-call'), res:el('n-res'), lres:el('n-lres'), final:el('n-final') };
  const hit = (k)=>{ if(N[k]) pulse(N[k]); };

  function setToolsList(csv){
    const toolsEl = el('tools');
    toolsEl.innerHTML = '';
    csv.split(',').map(s=>s.trim()).filter(Boolean).forEach(t=>{
      const span=document.createElement('span'); span.className='pill'; span.textContent=t; toolsEl.appendChild(span);
    });
  }

  function catOf(evt){
    const m = (evt.message||'');
    if (m.startsWith('PromptRender:')) return 'prompt';
    if (m.startsWith('Agent:')) return 'agent';
    if (m.startsWith('SK:')) {
      if (m.includes('LLM.Request') || m.includes('LLM.Response')) return 'llm';
      if (m.includes('Stream.Text')) return 'llm';
    }
    if (m.startsWith('Func:') || m.startsWith('Tool:')) return 'tool';
    return 'oth';
  }
  function labelOf(evt){
    const m = evt.message || '';
    if (m.startsWith('PromptRender:Start')) return 'Prompt.Start';
  if (m.startsWith('PromptRender:Done')) return 'Prompt.Done';
    if (m.includes('LLM.Request')) return 'LLM.Request';
    if (m.includes('LLM.Response.Final')) return 'LLM.Final';
    if (m.includes('LLM.Response')) return 'LLM.Response';
    if (m.includes('Stream.Text')) return 'Stream.Text';
    if (m.startsWith('Func:Call') || m.startsWith('Tool:Call')) return 'Tool.Call';
    if (m.startsWith('Func:Args')) return 'Tool.Args';
    if (m.startsWith('Func:Result') || m.startsWith('Tool:Result')) return 'Tool.Result';
    if (m.startsWith('Tool:')) return m.split(':')[1] || 'Tool';
    if (m.startsWith('Agent:')) return m.replace('Agent:','').split('.')[0];
    return 'Event';
  }

  const TL = { list:[], zoom:1.0 };
  const ck = { llm:el('ck-llm'), prompt:el('ck-prompt'), tool:el('ck-tool'), agent:el('ck-agent'), oth:el('ck-oth') };
  function passFilter(r){
    const m = (el('q').value||'').toLowerCase();
    return (ck[r.cat] && ck[r.cat].checked) && (!m || r.msg.toLowerCase().includes(m) || String(r.data||'').toLowerCase().includes(m));
  }
  function renderTimeline(){
    const svg=el('tl-svg'), feed=el('feed');
    const items = TL.list.filter(passFilter);
    if(items.length===0){ svg.innerHTML=''; feed.innerHTML=''; return; }
    const t0 = items[0].t, t1 = items[items.length-1].t, span = Math.max(1, (t1 - t0));
    const W = svg.clientWidth||800, H=90, mid=H/2;
    const grid = `<line x1="0" y1="${mid}" x2="${W}" y2="${mid}" stroke="#e5e7eb" stroke-width="1"/>`;
    const color = (c)=> c==='llm'?'var(--c-llm)':c==='prompt' ? 'var(--c-prompt)' :c==='tool'?'var(--c-tool)':c==='agent'?'var(--c-agent)':'var(--c-oth)';
    const dots = items.map((r,i)=>{
      const x = Math.max(2, Math.min(W-2, Math.round(((r.t - t0)/span) * W * TL.zoom)));
      const y = mid + Math.sin(i/3) * 18;
      return `<circle cx="${x}" cy="${y}" r="5" fill="${color(r.cat)}"><title>${new Date(r.t).toLocaleTimeString()} • ${r.cat} • ${r.label}</title></circle>`;
    }).join('');
    svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
    svg.innerHTML = grid + dots;

    feed.innerHTML = items.map(r=>{
      const t = new Date(r.t).toLocaleTimeString();
      let data=''; try{ data = JSON.stringify(JSON.parse(String(r.data||'')),null,2); } catch{ data = String(r.data||''); }
      return `<div class="rowfeed"><div>${t}</div><div><b>${r.cat}</b> • ${r.label}</div><div><b>${r.msg}</b>${data?`<pre>${data}</pre>`:''}</div></div>`;
    }).join('');
  }
  ['q','ck-llm','ck-prompt','ck-tool','ck-agent','ck-oth'].forEach(id=>el(id).addEventListener('input', renderTimeline));
  el('zoom-in').addEventListener('click',()=>{ TL.zoom=Math.min(5, TL.zoom+0.25); renderTimeline(); });
  el('zoom-out').addEventListener('click',()=>{ TL.zoom=Math.max(0.25, TL.zoom-0.25); renderTimeline(); });
  el('clear').addEventListener('click',()=>{ TL.list=[]; renderTimeline(); });
  el('export').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(TL.list.filter(passFilter),null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`timeline.json`; a.click(); URL.revokeObjectURL(url);
  });

  const TC = { rows:[], currentId:null };
  const tcBody = el('tc-body'), tcCount = el('tc-count');
  function pushTC(row){ TC.rows.unshift(row); tcCount.textContent=TC.rows.length; renderTC(); }
  function renderTC(){
    tcBody.innerHTML='';
    TC.rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.time).toLocaleTimeString()}</td><td>${r.plugin}</td><td>${r.func}</td><td></td><td>${r.data}</td><td></td>`;
      tcBody.appendChild(tr);
    });
  }

  conn.on('flowEvent', (evt) => {
    const t = nowMs(evt);
    const cat = catOf(evt), label=labelOf(evt);

    if (evt.message?.includes('Prompt.Render')) hit('prompt');
    if (evt.message?.includes('LLM.Request')) hit('req');
    if (evt.message?.includes('Stream.Text')) hit('stream');
    if (evt.message?.startsWith('Func:Call') || evt.message?.startsWith('Tool:Call')) hit('call');
    if (evt.message === 'Func:Result' || evt.message==='Tool:Result') hit('res');
    if (evt.message?.includes('LLM.Response.Final')) hit('final');
    else if (evt.message?.includes('LLM.Response')) hit('lres');

    if (evt.message === 'SK:Tools.Registered' && evt.data) setToolsList(String(evt.data));

    TL.list.push({ t, cat, label, msg:evt.message||'', data:evt.data||'' });
    if (TL.list.length>500) TL.list.shift();
    renderTimeline();
  });

  renderTimeline(); renderTC();
</script>
</body>
</html>
